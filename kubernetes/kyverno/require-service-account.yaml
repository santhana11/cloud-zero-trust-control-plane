# ------------------------------------------------------------------------------
# Kyverno â€” Require ServiceAccount
# ------------------------------------------------------------------------------
# Pods must explicitly set spec.serviceAccountName (or automountServiceAccountToken
# is controlled). Ensures workloads run with a known identity (e.g. IRSA).
# Exclude namespaces that use default SA by design (e.g. kube-system).
#
# validationFailureAction: Enforce = reject pods without explicit SA in target namespaces.
# ------------------------------------------------------------------------------
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-service-account
  annotations:
    policies.kyverno.io/title: Require explicit ServiceAccount
    policies.kyverno.io/severity: medium
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: require-service-account-name
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaces:
                - app-prod
                - app-dev
      validate:
        message: "Pods must set spec.serviceAccountName to a non-default service account (e.g. for IRSA)."
        pattern:
          spec:
            serviceAccountName: "?*"
        # Reject "default" if you want to force a named SA:
        # deny:
        #   conditions:
        #     - key: "{{ request.object.spec.serviceAccountName }}"
        #       operator: Equals
        #       value: "default"
